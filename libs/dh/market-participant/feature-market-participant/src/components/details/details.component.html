<!--
@license
Copyright 2020 Energinet DataHub A/S

Licensed under the Apache License, Version 2.0 (the "License2");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
@let loadedMarketParticipant = marketParticipant();

<ng-container *transloco="let t; prefix: 'marketParticipant.actorsOverview.drawer'">
  <watt-drawer
    autoOpen
    [key]="loadedMarketParticipant?.id"
    [loading]="isLoading()"
    #drawer
    (closed)="closed()"
    [size]="drawerSize()"
  >
    <watt-drawer-topbar>
      <dh-market-participant-status-badge [status]="loadedMarketParticipant?.status" />
    </watt-drawer-topbar>

    @if (canEdit()) {
      <watt-drawer-actions>
        <watt-button
          *dhPermissionRequired="['actor-master-data:manage']"
          variant="secondary"
          (click)="editMarketParticipant()"
          >{{ t("edit") }}</watt-button
        >
      </watt-drawer-actions>
    }

    <watt-drawer-heading>
      <h2 class="watt-space-stack-s">
        @if (loadedMarketParticipant?.glnOrEicNumber) {
          {{ loadedMarketParticipant?.glnOrEicNumber }} â€¢ {{ loadedMarketParticipant?.name }}
        } @else {
          {{ loadedMarketParticipant?.name }}
        }
      </h2>

      <vater-stack direction="row" gap="ml">
        <vater-stack direction="row" gap="s">
          <span class="watt-label">{{ t("metadata.marketRole") }}</span>
          <span>
            @if (loadedMarketParticipant?.marketRole) {
              {{
                "marketParticipant.marketRoles." + loadedMarketParticipant?.marketRole | transloco
              }}
            } @else {
              {{ loadedMarketParticipant?.marketRole | dhEmDashFallback }}
            }
          </span>
        </vater-stack>

        <vater-stack direction="row" gap="s">
          <span class="watt-label">{{ t("metadata.organization") }}</span>
          <span>{{ loadedMarketParticipant?.organization?.name | dhEmDashFallback }}</span>
        </vater-stack>
      </vater-stack>
    </watt-drawer-heading>

    @if (drawer.isOpen() && loadedMarketParticipant) {
      <watt-drawer-content>
        <watt-tabs>
          <watt-tab [label]="t('tabs.masterData.tabLabel')">
            <vater-stack direction="column" gap="ml" align="stretch" fill="horizontal">
              <watt-card variant="solid">
                <watt-card-title>
                  <h3>{{ t("tabs.masterData.actor") }}</h3>
                </watt-card-title>
                <watt-description-list variant="stack" [itemSeparators]="false">
                  <watt-description-list-item
                    [label]="t('tabs.masterData.glnOrEic')"
                    [value]="loadedMarketParticipant.glnOrEicNumber"
                  />

                  <watt-description-list-item
                    [label]="t('tabs.masterData.name')"
                    [value]="loadedMarketParticipant.name"
                  />

                  @if (isGridAccessProvider()) {
                    <watt-description-list-item
                      [label]="t('tabs.masterData.gridArea')"
                      [value]="gridAreaOrFallback()"
                    />
                  }

                  <watt-description-list-item
                    [label]="t('tabs.masterData.marketRole')"
                    [value]="marketRoleOrFallback()"
                  />
                </watt-description-list>
                <hr class="watt-divider" />
                <h4>{{ t("tabs.masterData.contact") }}</h4>
                <watt-description-list variant="stack" [itemSeparators]="false"
                  >/>
                  <watt-description-list-item
                    [label]="t('tabs.masterData.nameOrDepartment')"
                    [value]="loadedMarketParticipant.contact?.name"
                  />
                  <watt-description-list-item
                    [label]="t('tabs.masterData.email')"
                    [value]="loadedMarketParticipant.contact?.email"
                  />
                  <watt-description-list-item
                    [label]="t('tabs.masterData.phoneNumber')"
                    [value]="loadedMarketParticipant.contact?.phone"
                  />
                </watt-description-list>
              </watt-card>
              <watt-card variant="solid">
                <watt-card-title>
                  <vater-stack direction="row" justify="space-between">
                    <h3>{{ t("tabs.masterData.organization") }}</h3>

                    <watt-button
                      *dhPermissionRequired="['actors:manage']"
                      (click)="editOrganization(loadedMarketParticipant.organization.id)"
                      variant="text"
                      >{{ t("tabs.masterData.editOrganization") }}</watt-button
                    >
                  </vater-stack>
                </watt-card-title>

                <watt-description-list variant="stack" [itemSeparators]="false">
                  <watt-description-list-item
                    [label]="t('tabs.masterData.cvr')"
                    [value]="loadedMarketParticipant.organization.businessRegisterIdentifier"
                  />
                  <watt-description-list-item
                    [label]="t('tabs.masterData.organizationName')"
                    [value]="loadedMarketParticipant.organization.name"
                  />
                  <watt-description-list-item
                    [label]="t('tabs.masterData.organizationCountry')"
                    [value]="loadedMarketParticipant.organization.address.country"
                  />
                  <watt-description-list-item [label]="t('tabs.masterData.domains')">
                    <vater-stack wrap direction="row" gap="s">
                      @for (domain of loadedMarketParticipant.organization.domains; track domain) {
                        <watt-chip [readonly]="true">{{ domain }}</watt-chip>
                      }
                    </vater-stack>
                  </watt-description-list-item>
                </watt-description-list>
              </watt-card>
            </vater-stack>
          </watt-tab>

          @if (canEdit()) {
            <watt-tab
              [label]="t('tabs.b2bAccess.tabLabel')"
              *dhPermissionRequired="['actor-credentials:manage']"
            >
              <dh-b2b-access-tab [marketParticipantId]="loadedMarketParticipant.id" />
            </watt-tab>

            <ng-container *dhPermissionRequired="['delegation:view']">
              <watt-tab
                [label]="t('tabs.delegation.tabLabel')"
                *dhCanDelegateFor="loadedMarketParticipant.marketRole"
              >
                @defer (on viewport) {
                  <dh-delegation-tab [actor]="loadedMarketParticipant" />
                } @placeholder {
                  <watt-spinner />
                }
              </watt-tab>
            </ng-container>

            <ng-container *dhReleaseToggle="'PG29-Additional-recipients'">
              <ng-container *dhPermissionRequired="['additional-recipients:view']">
                @if (showAdditionalRecipientsTab()) {
                  <watt-tab [label]="t('tabs.accessToMeasurements.tabLabel')">
                    @defer (on viewport) {
                      <dh-access-to-measurements-tab
                        [marketParticipant]="loadedMarketParticipant"
                      />
                    } @placeholder {
                      <watt-spinner />
                    }
                  </watt-tab>
                }
              </ng-container>
            </ng-container>

            <ng-container *dhPermissionRequired="['balance-responsibility:view']">
              @if (showBalanceResponsibleRelationTab()) {
                <watt-tab [label]="t('tabs.balanceResponsibleRelation.tabLabel')">
                  <dh-balance-responsible-relation-tab
                    [marketParticipant]="loadedMarketParticipant"
                  />
                </watt-tab>
              }
            </ng-container>
          }

          <watt-tab [label]="t('tabs.history.tabLabel')" *dhPermissionRequired="['actors:manage']">
            @defer (on viewport) {
              <dh-market-participant-audit-log-tab [marketParticipant]="loadedMarketParticipant" />
            } @placeholder {
              <watt-spinner />
            }
          </watt-tab>
        </watt-tabs>
      </watt-drawer-content>
    }
  </watt-drawer>
</ng-container>

<router-outlet />
